<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team 5171 | Start Guide</title>
    <meta name="description" content="Technical documentation and start guide for Team 5171.">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@600;700;800&display=swap"
        rel="stylesheet">

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-dark: #090b0f;
            --glass-bg: rgba(22, 27, 34, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-primary: #58a6ff;
            --accent-secondary: #bc8cff;
            --text-main: #e6edf3;
            --text-dim: #8b949e;
            --sidebar-width: 280px;
            --aside-width: 320px;
            --nav-height: 60px;
            --glow: 0 0 20px rgba(88, 166, 255, 0.15);
        }

        * {
            box-sizing: border-box;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            margin: 0;
            background: var(--bg-dark);
            background-image:
                radial-gradient(circle at 0% 0%, rgba(88, 166, 255, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(188, 140, 255, 0.1) 0%, transparent 40%);
            color: var(--text-main);
            height: 100vh;
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            overflow: hidden;
        }

        /* Sidebar Styling */
        nav {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .nav-header {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .logo-circle {
            width: 32px;
            height: 32px;
            background-image: url('https://github.com/team5171.png');
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            box-shadow: var(--glow);
        }

        .nav-header h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            margin: 0;
            background: linear-gradient(to right, #fff, #8b949e);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-group-title {
            padding: 24px 24px 8px;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .nav-link {
            padding: 10px 24px;
            margin: 2px 12px;
            border-radius: 10px;
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }

        .nav-link.active {
            background: rgba(88, 166, 255, 0.1);
            color: var(--accent-primary);
            font-weight: 500;
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 25%;
            height: 50%;
            width: 3px;
            background: var(--accent-primary);
            border-radius: 0 4px 4px 0;
            box-shadow: var(--glow);
        }

        /* Sidebar TOC */
        .sidebar-toc {
            display: none;
            /* Hidden by default, shown when page is active */
            flex-direction: column;
            margin-top: 8px;
            border-top: 1px solid var(--glass-border);
            padding-top: 8px;
        }

        .sidebar-toc.active {
            display: flex;
        }

        .toc-link {
            display: block;
            padding: 6px 36px;
            /* Indented more than nav links */
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.85rem;
            border-left: 2px solid transparent;
        }

        .toc-link:hover {
            color: var(--text-main);
        }

        .toc-link.active {
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
        }

        .toc-h3 {
            padding-left: 48px;
            font-size: 0.8rem;
        }

        /* Main Content area */
        main {
            padding: 40px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        #content {
            max-width: 900px;
            margin: 0 auto;
            background: transparent;
            padding: 0;
            border: none;
            box-shadow: none;
        }

        /* Markdown Content Container - wrapper for md files */
        .markdown-body {
            background: rgba(255, 255, 255, 0.02);
            padding: 48px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            line-height: 1.8;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .markdown-body h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 2.5rem;
            margin-top: 0;
            margin-bottom: 2rem;
            color: white;
        }

        .markdown-body h2 {
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            color: #fff;
        }

        .markdown-body blockquote {
            border-left: 4px solid var(--accent-primary);
            padding: 1rem 2rem;
            margin: 2rem 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0 12px 12px 0;
        }

        .markdown-body code {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
        }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .dash-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .dash-card h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            margin: 0 0 16px 0;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Countdown Card */
        .countdown-container {
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .countdown-container:hover {
            transform: scale(1.02);
        }

        .countdown-timer {
            font-family: 'Outfit', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 12px 0;
            line-height: 1;
        }

        .countdown-label {
            font-size: 1rem;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .countdown-link-hint {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 12px;
            opacity: 0.7;
        }

        /* Activity Feed in Dashboard */
        .activity-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .activity-icon {
            margin-top: 4px;
            color: var(--text-dim);
        }

        .activity-content {
            flex: 1;
        }

        .activity-author {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--accent-secondary);
        }

        .activity-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
        }

        .activity-msg {
            font-size: 0.9rem;
            color: var(--text-main);
            margin: 4px 0;
        }

        .activity-date {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            /* No longer relevant as we removed the 3rd column */
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
            }

            nav {
                position: fixed;
                transform: translateX(-100%);
                width: 280px;
                height: 100vh;
            }

            nav.open {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
            }

            nav {
                position: fixed;
                transform: translateX(-100%);
                width: 280px;
                height: 100vh;
            }

            nav.open {
                transform: translateX(0);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        select.config-select {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-dim);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            font-size: 0.7rem;
            padding: 4px 6px;
            outline: none;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s ease;
        }

        select.config-select:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
            color: var(--text-main);
        }

        /* Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .modal h3 {
            margin-top: 0;
            font-family: 'Outfit', sans-serif;
            color: white;
        }

        .modal input,
        .modal textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: white;
            padding: 12px;
            margin-bottom: 16px;
            font-family: 'Inter', sans-serif;
        }

        .modal textarea {
            height: 200px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: #0d1117;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--glass-border);
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--accent-primary);
            color: #0d1117;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            display: none;
            z-index: 1001;
            box-shadow: 0 8px 24px rgba(88, 166, 255, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .nav-footer {
            margin-top: auto;
            padding: 24px;
            border-top: 1px solid var(--glass-border);
            font-size: 0.75rem;
            color: var(--text-dim);
            text-align: center;
        }

        .nav-footer strong {
            color: var(--accent-primary);
            font-weight: 600;
        }

        /* Auth Overlay */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #090b0f;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .auth-box {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 50px rgba(88, 166, 255, 0.1);
        }

        .auth-box h2 {
            margin-top: 0;
            font-family: 'Outfit', sans-serif;
            color: white;
        }

        .auth-box p {
            color: var(--text-dim);
            margin-bottom: 24px;
        }
    </style>
</head>

<body>
    <nav id="sidebar">
        <div class="nav-header">
            <div class="logo-circle"></div>
            <h1 onclick="renderDashboard()" style="cursor: pointer;">Start Guide</h1>
        </div>
        <div class="nav-group-title">Navigation</div>
        <div id="page-list">
            <a class="nav-link dashboard-link" onclick="renderDashboard()">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.8;">
                    <path
                        d="M1 3a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V3zm2-1a1 1 0 00-1 1v1h12V3a1 1 0 00-1-1H3zm12 3H1v8a1 1 0 001 1h10a1 1 0 001-1V5z">
                    </path>
                </svg>
                Dashboard
            </a>
            <div class="nav-link">Loading files...</div>
        </div>

        <!-- Sidebar TOC Container -->
        <div id="sidebar-toc-container" class="sidebar-toc">
            <div class="nav-group-title">Table of Contents</div>
            <div id="toc"></div>
        </div>
        <div class="nav-group-title">Actions</div>
        <div class="nav-link" onclick="sharePage()">
            <img src="svg/share.svg" width="16" height="16" style="opacity: 0.8;"> Share Page
        </div>
        <div class="nav-link" onclick="editPage()">
            <img src="svg/edit.svg" width="16" height="16" style="opacity: 0.8;"> Edit in GitHub
        </div>
        <div class="nav-link" onclick="addPageModal()">
            <img src="svg/add.svg" width="16" height="16" style="opacity: 0.8;"> Add New Page
        </div>
        <div class="nav-footer">
            Created by <strong>Veer Bajaj</strong> with <strong>Team 5171</strong>
            Kiwi Docs v2.0.1
        </div>
    </nav>

    <main>
        <div id="content">
            <!-- Dashboard Content -->
            <div id="dashboard-container"></div>

            <!-- Markdown Content -->
            <div id="markdown-container" class="markdown-body" style="display: none;"></div>
        </div>
    </main>



    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="modal-title">Add New Page</h3>
            <input type="text" id="page-name" placeholder="Page name (e.g. Getting Started)">
            <textarea id="page-content" placeholder="Page content (Markdown supported)"></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitAddPage()">Create on GitHub</button>
            </div>
        </div>
    </div>

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="auth-overlay">
        <div class="auth-box" id="auth-step-1">
            <div class="logo-circle" style="width: 48px; height: 48px; margin: 0 auto 16px;"></div>
            <h2>Security Check</h2>
            <p>To access internal documentation, please verify your identity.</p>
            <input type="text" id="mascot-input" placeholder="What is our mascot?">
            <button class="btn btn-primary" style="width: 100%;" onclick="checkMascot()">Verify</button>
            <div id="auth-error-1" style="color: #ff7b72; font-size: 0.8rem; margin-top: 12px; display: none;">
                Incorrect. Try again.</div>
        </div>

        <div class="auth-box" id="auth-step-2" style="display: none;">
            <div class="logo-circle" style="width: 48px; height: 48px; margin: 0 auto 16px;"></div>
            <h2>Enter Access Token</h2>
            <p>Please enter your GitHub Personal Access Token (PAT) to view secure content.</p>
            <input type="password" id="pat-input" placeholder="ghp_...">
            <button class="btn btn-primary" style="width: 100%;" onclick="savePat()">Access Docs</button>
            <div style="margin-top: 16px; font-size: 0.75rem; color: var(--text-dim);">
                Token is stored locally in your browser and never sent to our servers.
            </div>
        </div>
    </div>

    <div id="toast">Link copied to clipboard!</div>

    <script>
        const CONFIG = {
            owner: "team5171",
            repo: "2026docs",
            activityRepo: "FRC-2026",
            branch: "main",
            defaultFile: "README.md",
            logo: "https://github.com/team5171.png",
            baseUrl: "https://team5171.github.io/2026docs",
            authWorker: "https://team5171pat.veerbajaj11.workers.dev" // Enter your Worker URL here (e.g., https://auth.team5171.workers.dev)
        };
        const ENABLE_AUTO_AUTH = false;

        const state = {
            currentPath: CONFIG.defaultFile,
            pat: localStorage.getItem('gh_pat') || null
        };

        const ENDPOINTS = {
            contents: `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents?ref=${CONFIG.branch}`,
            raw: (path) => `https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/${CONFIG.branch}/${path}`
        };

        function getHeaders() {
            return state.pat ? { 'Authorization': `token ${state.pat}` } : {};
        }

        if (!state.pat) {
            console.warn("GitHub features locked (no auth)");
        }

        async function init() {
            let hasAuth = false;

            if (state.pat) {
                hasAuth = true;
                document.getElementById('auth-overlay').style.display = 'none';
            }
            else if (CONFIG.authWorker && ENABLE_AUTO_AUTH) {
                const autoToken = await tryAutoAuth();
                if (autoToken) {
                    state.pat = autoToken;
                    localStorage.setItem('gh_pat', autoToken);
                    hasAuth = true;
                    document.getElementById('auth-overlay').style.display = 'none';
                } else {
                    document.getElementById('auth-overlay').style.display = 'flex';
                }
            }
            else {
                document.getElementById('auth-overlay').style.display = 'flex';
            }

            // ðŸ”“ APP ALWAYS CONTINUES
            try {
                const params = new URLSearchParams(window.location.search);
                const requested =
                    params.get('page') ||
                    (window.location.search.length > 1
                        ? window.location.search.substring(1)
                        : null);

                await loadFileList(hasAuth); // optional flag if needed

                if (!requested) {
                    renderDashboard();
                }

            } catch (err) {
                console.error("Initialization failed:", err);
            }
        }

        // Auth Functions
        async function tryAutoAuth() {
            try {
                // Determine if we are on the correct origin to avoid unnecessary errors
                // However, the worker handles the origin check, so we can just try.
                const res = await fetch(CONFIG.authWorker);
                if (res.ok) {
                    const data = await res.json();
                    return data.token;
                }
            } catch (err) {
                console.log("Auto-auth skipped or failed.");
            }
            return null;
        }

        function checkMascot() {
            const input = document.getElementById('mascot-input').value.trim().toLowerCase();
            const error = document.getElementById('auth-error-1');

            if (input === 'falcons') {
                document.getElementById('auth-step-1').style.display = 'none';
                document.getElementById('auth-step-2').style.display = 'block';
                error.style.display = 'none';
            } else {
                error.style.display = 'block';
                document.getElementById('mascot-input').classList.add('shake');
                setTimeout(() => document.getElementById('mascot-input').classList.remove('shake'), 500);
            }
        }

        function savePat() {
            const token = document.getElementById('pat-input').value.trim();
            if (token) {
                localStorage.setItem('gh_pat', token);
                state.pat = token;
                document.getElementById('auth-overlay').style.display = 'none';
                init();
            }
        }

        async function loadFileList() {
            const container = document.getElementById('page-list');
            try {
                const res = await fetch(ENDPOINTS.contents, { headers: getHeaders() });
                if (res.status === 401 || res.status === 403) throw new Error("Unauthorized");
                if (!res.ok) throw new Error("Repo not found");

                const items = await res.json();
                const files = items.filter(i => i.name.endsWith('.md'));

                if (files.length === 0) {
                    container.innerHTML = `<div style="padding: 24px; color: var(--text-dim);">No guides found yet.</div>`;
                    return;
                }

                container.innerHTML = `
                    <a class="nav-link dashboard-link" onclick="renderDashboard()">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.8;"><path d="M1 3a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V3zm2-1a1 1 0 00-1 1v1h12V3a1 1 0 00-1-1H3zm12 3H1v8a1 1 0 001 1h10a1 1 0 001-1V5z"></path></svg>
                        Dashboard
                    </a>
                ` + files.map(file => {
                    const urlName = file.path.replace('.md', '');
                    const href = urlName.toLowerCase() === 'readme' ? './' : `?page=${urlName}`;
                    return `
                        <a class="nav-link" href="${href}" data-path="${file.path}" onclick="event.preventDefault(); loadFile('${file.path}', this)">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.6"><path d="M3.75 2h3.5l3.5 3.5v8.75A1.75 1.75 0 019 16H3.75A1.75 1.75 0 012 14.25V3.75C2 2.784 2.784 2 3.75 2z"></path></svg>
                            ${file.name.replace('.md', '')}
                        </a>
                    `;
                }).join('');

                // Load default if exists
                const params = new URLSearchParams(window.location.search);
                const requested = params.get('page') || params.get('') || window.location.search.substring(1);

                const target = files.find(f => f.name.toLowerCase() === (requested + ".md").toLowerCase())
                    || files.find(f => f.path.toLowerCase() === (requested + ".md").toLowerCase())
                    || files.find(f => f.name === CONFIG.defaultFile)
                    || files[0];

                if (target) {
                    const el = document.querySelector(`[data-path="${target.path}"]`);
                    loadFile(target.path, el);
                } else {
                    // No matching file and no default file found/requested -> Dashboard
                    renderDashboard();
                }

            } catch (err) {
                if (err.message === "Unauthorized") {
                    // Clear PAT and re-auth if token is bad
                    localStorage.removeItem('gh_pat');
                    state.pat = null;
                    init(); // Will trigger auth overlay
                    return;
                }
                container.innerHTML = `<div style="padding: 24px; font-size: 0.8rem; color: #ff7b72;">
                    Failed to connect to GitHub.<br>
                    Verify <strong>${CONFIG.owner}/${CONFIG.repo}</strong> is accessible.
                </div>`;
            }
        }

        async function loadFile(path, element) {
            state.currentPath = path;
            // Hide Dashboard, Show Markdown
            document.getElementById('dashboard-container').style.display = 'none';
            const mdContainer = document.getElementById('markdown-container');
            mdContainer.style.display = 'block';

            // Hide Sidebar TOC initially (will be populated/shown by generateTOC)
            document.getElementById('sidebar-toc-container').classList.remove('active');

            // Clear active states
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

            if (element) {
                element.classList.add('active');
            } else {
                const target = document.querySelector(`[data-path="${path}"]`);
                if (target) target.classList.add('active');
            }

            try {
                mdContainer.innerHTML = `<div style="text-align: center; padding: 100px;">Loading content...</div>`;

                // For raw content, we can try using the API to get content if it's private and raw.githubusercontent doesn't support auth via token in URL easily (it does via header but raw.githubusercontent is CORS strict sometimes).
                // Better to use the API contents endpoint with Accept: application/vnd.github.v3.raw

                const rawUrl = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${path}?ref=${CONFIG.branch}`;
                const res = await fetch(rawUrl, {
                    headers: {
                        ...getHeaders(),
                        'Accept': 'application/vnd.github.v3.raw'
                    }
                });

                if (!res.ok) throw new Error("Failed to load");
                const text = await res.text();

                mdContainer.innerHTML = marked.parse(text);

                // Fix relative asset paths - logic updated to use API for checking or just reconstruct raw URLs
                // Note: Binary assets in private repos are tricky with simple img src. 
                // We'll assume public for assets OR use creating object URLs which is complex.
                // For now, let's keep the raw endpoint replacement for public/consistent usage, but it might break for private images without a token in the URL.
                // A common workaround is ?token=... but we don't get that easily.
                // Let's stick to the previous implementation for assets, but maybe prepend the raw base.

                const currentDir = path.includes('/') ? path.substring(0, path.lastIndexOf('/') + 1) : '';
                mdContainer.querySelectorAll('img, video, audio, source').forEach(el => {
                    ['src', 'poster'].forEach(attr => {
                        const val = el.getAttribute(attr);
                        if (val && !val.startsWith('http') && !val.startsWith('/') && !val.startsWith('data:')) {
                            const fullPath = currentDir + val;
                            // For private images to work in <img> tags, we'd need a signed URL or blob. 
                            // If this is a public repo, raw.githubusercontent works. 
                            // If private, this remains a limitation of static sites without a proxy.
                            // However, we can try using the raw endpoint.
                            el.setAttribute(attr, `https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/${CONFIG.branch}/${fullPath}`);
                        }
                    });
                });

                generateTOC(mdContainer);
                document.querySelector('main').scrollTop = 0;

                const urlName = path.replace('.md', '');
                const cleanBase = window.location.pathname.split('?')[0].split('#')[0];
                const repoBase = cleanBase.endsWith('/') ? cleanBase : cleanBase.substring(0, cleanBase.lastIndexOf('/') + 1);
                const finalBase = repoBase.endsWith('index.html/') ? repoBase.replace('index.html/', '') : repoBase;
                const newQuery = urlName.toLowerCase() === 'readme' ? '' : `?page=${urlName}`;
                window.history.replaceState({ path }, null, finalBase + newQuery);

                mdContainer.querySelectorAll('a').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && !href.startsWith('http') && !href.startsWith('#')) {
                        link.onclick = (e) => {
                            const isDoc = href.endsWith('.md') || !href.includes('.');
                            if (!isDoc) return;
                            e.preventDefault();
                            let targetPath = href;
                            if (!href.startsWith('/')) {
                                const currentDir = path.includes('/') ? path.substring(0, path.lastIndexOf('/') + 1) : '';
                                targetPath = currentDir + href;
                            } else {
                                targetPath = href.substring(1);
                            }
                            if (!targetPath.endsWith('.md') && !targetPath.includes('.')) targetPath += '.md';
                            loadFile(targetPath);
                        };
                    }
                });
            } catch (err) {
                mdContainer.innerHTML = `<h1>Error</h1><p>Failed to load ${path}. Ensure the file exists and you have access.</p>`;
            }
        }

        function refreshActivity() {
            const year = document.getElementById('year-select').value;
            const type = document.getElementById('type-select').value;
            const view = document.getElementById('view-select').value;

            let repoName;
            if (type === 'testbot') {
                repoName = `testbot${year}`;
            } else {
                repoName = `FRC-${year}`;
            }

            loadActivity(repoName, view);
        }

        async function loadActivity(repoName, view) {
            const feed = document.getElementById('activity-feed');
            feed.innerHTML = `<div style="font-size: 0.8rem; padding: 12px 0; color: var(--text-dim);">Loading ${view}...</div>`;

            try {
                let url;
                if (view === 'commits') {
                    url = `https://api.github.com/repos/${CONFIG.owner}/${repoName}/commits?per_page=10`;
                } else if (view === 'issues') {
                    url = `https://api.github.com/repos/${CONFIG.owner}/${repoName}/issues?state=open&per_page=10`;
                } else if (view === 'pulls') {
                    url = `https://api.github.com/repos/${CONFIG.owner}/${repoName}/pulls?state=open&per_page=10`;
                }

                const res = await fetch(url, { headers: getHeaders() });
                if (!res.ok) throw new Error("Data not found");
                const items = await res.json();

                if (items.length === 0) {
                    feed.innerHTML = `<p style="font-size: 0.8rem; color: var(--text-dim);">No ${view} found.</p>`;
                    return;
                }

                feed.innerHTML = items.map(item => {
                    if (view === 'commits') {
                        return `
                            <div class="activity-item">
                                <div class="activity-author">${item.commit.author.name}</div>
                                <div class="activity-msg"><a href="${item.html_url}" target="_blank" style="color: inherit; text-decoration: none;">${item.commit.message.split('\n')[0]}</a></div>
                                <div class="activity-date">${new Date(item.commit.author.date).toLocaleDateString()}</div>
                            </div>
                        `;
                    } else if (view === 'issues') {
                        // GitHub issues API also returns PRs, filter them out if strictly looking for issues? 
                        // Actually 'issues' endpoint includes PRs unless we filter. 
                        // But usually the UI distinction helps. 
                        // Start with basic render.
                        if (item.pull_request) return ''; // Skip PRs in issues view if desired, but user might want everything. Let's keep distinct.

                        return `
                            <div class="activity-item">
                                <div class="activity-author">#${item.number} ${item.user.login}</div>
                                <div class="activity-msg"><a href="${item.html_url}" target="_blank" style="color: inherit; text-decoration: none;">${item.title}</a></div>
                                <div class="activity-date">Comments: ${item.comments}</div>
                            </div>
                        `;
                    } else if (view === 'pulls') {
                        return `
                            <div class="activity-item">
                                <div class="activity-author">#${item.number} ${item.user.login}</div>
                                <div class="activity-msg"><a href="${item.html_url}" target="_blank" style="color: inherit; text-decoration: none;">${item.title}</a></div>
                                <div class="activity-date">State: ${item.state}</div>
                            </div>
                        `;
                    }
                }).join('');

            } catch (err) {
                feed.innerHTML = `<p style="font-size: 0.8rem; color: #ff7b72;">Failed to load ${view} for ${repoName}.</p>`;
            }
        }

        function generateTOC(contentElement) {
            const tocContainer = document.getElementById('toc');
            const sidebarToc = document.getElementById('sidebar-toc-container');
            const headings = contentElement.querySelectorAll('h1, h2, h3');
            tocContainer.innerHTML = '';

            if (headings.length === 0) {
                sidebarToc.classList.remove('active');
                return;
            }

            sidebarToc.classList.add('active');

            headings.forEach((h, i) => {
                const id = `heading-${i}`;
                h.id = id;
                const a = document.createElement('a');
                a.href = `#${id}`;
                a.className = `toc-link toc-${h.tagName.toLowerCase()}`;
                a.textContent = h.textContent;
                a.onclick = (e) => {
                    e.preventDefault();
                    h.scrollIntoView({ behavior: 'smooth' });
                    // Update active state manually
                    document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                    a.classList.add('active');
                };
                tocContainer.appendChild(a);
            });
        }

        // --- Dashboard Logic ---

        async function renderDashboard() {
            state.currentPath = 'Dashboard';
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector('.dashboard-link')?.classList.add('active');

            // Toggle containers
            document.getElementById('markdown-container').style.display = 'none';
            document.getElementById('sidebar-toc-container').classList.remove('active');
            const dash = document.getElementById('dashboard-container');
            dash.style.display = 'block';

            dash.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px;">
                    <div class="logo-circle" style="width: 80px; height: 80px; margin: 0 auto 16px;"></div>
                    <h1 style="font-family: 'Outfit'; font-size: 2.5rem; margin: 0;">2026 Season Overview</h1>
                    <p style="color: var(--text-dim);">Technical Hub for Team 5171</p>
                </div>

                <div class="dashboard-grid">
                    <!-- Countdown Card -->
                    <div class="dash-card" id="countdown-card">
                        <h2>
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4.75 0a.75.75 0 01.75.75V2h5V.75a.75.75 0 011.5 0V2h1.25c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0113.25 16H2.75A1.75 1.75 0 011 14.25V3.75C1 2.784 1.784 2 2.75 2H4V.75A.75.75 0 014.75 0zm0 3.5h8.5a.25.25 0 01.25.25V6h-9V3.75a.25.25 0 01.25-.25zM2.5 7.5v6.75c0 .138.112.25.25.25h10.5a.25.25 0 00.25-.25V7.5h-11z"></path></svg>
                            Next Event
                        </h2>
                        <div id="countdown-ui">
                            <div style="text-align: center; padding: 20px;">Loading Calendar...</div>
                        </div>
                    </div>

                    <!-- Activity Feed Card -->
                    <div class="dash-card">
                        <h2>
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M10.896 2H4.95A1.75 1.75 0 003.2 3.75v9.5c0 .966.784 1.75 1.75 1.75h6.926a1.75 1.75 0 001.75-1.75V3.75A1.75 1.75 0 0011.875 2h-.979zM5 3.5h5.875a.25.25 0 01.25.25v1.5a.25.25 0 01-.25.25H5a.25.25 0 01-.25-.25v-1.5A.25.25 0 015 3.5z"></path></svg>
                            Team Updates
                        </h2>
                        <div id="activity-feed"></div> <!-- Re-using ID for compatibility -->
                    </div>
                </div>
            `;

            // Start Widgets
            fetchICalData();
            loadMergedActivity();
        }

        let countdownInterval;

        async function fetchICalData() {
            const container = document.getElementById('countdown-ui');
            const card = document.getElementById('countdown-card');
            const url = `${CONFIG.authWorker}/calendar`;


            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Failed to fetch calendar");
                const text = await res.text();

                const events = parseICS(text);
                const nextEvent = getNextEvent(events);

                if (nextEvent) {
                    startCountdown(nextEvent, container, card);
                } else {
                    container.innerHTML = `<div style="text-align: center; color: var(--text-dim);">No upcoming events found.</div>`;
                }

            } catch (err) {
                console.error(err);
                container.innerHTML = `<div style="text-align: center; color: #ff7b72;">
                    Failed to load calendar (CORS).<br>
                    <a href="https://lu.ma/team5171" target="_blank" style="color: var(--accent-primary); text-decoration: none;">View on Luma â†’</a>
               </div>`;
            }
        }

        async function loadMergedActivity() {
            const feed = document.getElementById('activity-feed');
            feed.innerHTML = `<div style="font-size: 0.8rem; padding: 12px 0; color: var(--text-dim);">Synchronizing data...</div>`;

            try {
                const [commits, issues, pulls] = await Promise.all([
                    fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.activityRepo}/commits?per_page=5`, { headers: getHeaders() }).then(res => res.json()),
                    fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.activityRepo}/issues?state=open&per_page=5`, { headers: getHeaders() }).then(res => res.json()),
                    fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.activityRepo}/pulls?state=open&per_page=5`, { headers: getHeaders() }).then(res => res.json())
                ]);

                let merged = [
                    ...commits.map(c => ({
                        type: 'commit',
                        date: new Date(c.commit.author.date),
                        author: c.commit.author.name,
                        avatar: c.author?.avatar_url || CONFIG.logo,
                        msg: c.commit.message.split('\n')[0],
                        url: c.html_url
                    })),
                    ...issues.filter(i => !i.pull_request).map(i => ({
                        type: 'issue',
                        date: new Date(i.created_at),
                        author: i.user.login,
                        avatar: i.user.avatar_url,
                        msg: `Issue #${i.number}: ${i.title}`,
                        url: i.html_url
                    })),
                    ...pulls.map(p => ({
                        type: 'pr',
                        date: new Date(p.created_at),
                        author: p.user.login,
                        avatar: p.user.avatar_url,
                        msg: `PR #${p.number}: ${p.title}`,
                        url: p.html_url
                    }))
                ].sort((a, b) => b.date - a.date).slice(0, 10);

                if (merged.length === 0) {
                    feed.innerHTML = `<p style="font-size: 0.8rem; color: var(--text-dim);">No recent activity found.</p>`;
                    return;
                }

                feed.innerHTML = merged.map(item => `
                    <div class="activity-item" onclick="window.open('${item.url}', '_blank')" style="cursor: pointer;">
                        <img src="${item.avatar}" class="activity-avatar" alt="${item.author}">
                        <div class="activity-content">
                            <div class="activity-author">${item.author}</div>
                            <div class="activity-msg">${item.msg}</div>
                            <div class="activity-date">${item.date.toLocaleDateString()} at ${item.date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                feed.innerHTML = `<p style="font-size: 0.8rem; color: #ff7b72;">Failed to sync activity feed.</p>`;
            }
        }

        function parseICS(icsData) {
            const events = [];
            const lines = icsData.split(/\r\n|\n|\r/);
            let currentEvent = null;

            for (const line of lines) {
                if (line.startsWith('BEGIN:VEVENT')) {
                    currentEvent = {};
                } else if (line.startsWith('END:VEVENT')) {
                    if (currentEvent) events.push(currentEvent);
                    currentEvent = null;
                } else if (currentEvent) {
                    const [key, ...valueParts] = line.split(':');
                    const value = valueParts.join(':');
                    if (key && value) {
                        // Handle multiline descriptions? Simple parser for now.
                        // Ideally checking for DESCRIPTION and DTSTART
                        if (key.includes('DTSTART')) currentEvent.start = value;
                        if (key.includes('SUMMARY')) currentEvent.summary = value;
                        if (key.includes('DESCRIPTION')) currentEvent.description = value; // Might need to handle line folding
                    }
                }
            }
            return events;
        }

        function getNextEvent(events) {
            const now = new Date();
            const futureEvents = events.map(e => {
                // Parse date: YYYYMMDDTHHMMSSZ or YYYYMMDD
                // Simple parser needed
                const dStr = e.start;
                if (!dStr) return null;

                let date;
                // Handle basic ISO format from ICS
                if (dStr.length === 8) { // YYYYMMDD
                    const y = dStr.substring(0, 4), m = dStr.substring(4, 6), d = dStr.substring(6, 8);
                    date = new Date(`${y}-${m}-${d}`);
                } else { // YYYYMMDDTHHMMSS...
                    const y = dStr.substring(0, 4), m = dStr.substring(4, 6), d = dStr.substring(6, 8);
                    const h = dStr.substring(9, 11), min = dStr.substring(11, 13), s = dStr.substring(13, 15);
                    // Assuming UTC if ends in Z
                    if (dStr.endsWith('Z')) {
                        date = new Date(Date.UTC(y, m - 1, d, h, min, s));
                    } else {
                        date = new Date(y, m - 1, d, h, min, s);
                    }
                }

                return { ...e, date };
            }).filter(e => e && e.date > now).sort((a, b) => a.date - b.date);

            return futureEvents[0];
        }

        function startCountdown(event, container, card) {
            if (countdownInterval) clearInterval(countdownInterval);

            // Extract URL
            // Regex: Get up-to-date information at:\s*(https?://[^\s]+)
            // Note: Description might be escaped in ICS (e.g. \\n).
            const desc = event.description || "";
            const urlMatch = desc.match(/Get up-to-date information at:\\?[n\s]*(https?:\/\/[^\s\\]+)/) || desc.match(/(https?:\/\/[^\s]+)/);
            const targetUrl = urlMatch ? urlMatch[1] : null;

            if (targetUrl) {
                card.onclick = () => window.open(targetUrl, '_blank');
                container.innerHTML += `<div class="countdown-link-hint">Click to view event details</div>`;
            }

            const update = () => {
                const now = new Date().getTime();
                const distance = event.date.getTime() - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    container.innerHTML = "Event Started!";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                container.innerHTML = `
                    <div class="countdown-label">Next Event: ${event.summary}</div>
                    <div class="countdown-timer">${days}d ${hours}h ${minutes}m ${seconds}s</div>
                    <div class="app-date">${event.date.toLocaleDateString()} at ${event.date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                    ${targetUrl ? '<div class="countdown-link-hint">Click for details</div>' : ''}
                `;
            };

            update();
            countdownInterval = setInterval(update, 1000);
        }

        // Mobile Sidebar Toggle
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        // Actions
        function sharePage() {
            const pageName = state.currentPath.replace('.md', '');
            const url = pageName.toLowerCase() === 'readme'
                ? CONFIG.baseUrl + '/'
                : `${CONFIG.baseUrl}/${pageName}`;

            navigator.clipboard.writeText(url).then(() => {
                const toast = document.getElementById('toast');
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 3000);
            });
        }

        function editPage() {
            const url = `https://github.com/${CONFIG.owner}/${CONFIG.repo}/edit/${CONFIG.branch}/${state.currentPath}`;
            window.open(url, '_blank');
        }

        function addPageModal() {
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function submitAddPage() {
            const name = document.getElementById('page-name').value.trim();
            const contents = document.getElementById('page-content').value;

            if (!name) {
                alert("Please enter a page name.");
                return;
            }

            const url = `https://github.com/${CONFIG.owner}/${CONFIG.repo}/new/${CONFIG.branch}?filename=${encodeURIComponent(name)}.md&value=${encodeURIComponent(contents)}`;
            window.open(url, '_blank');
            closeModal();
        }

        init();
    </script>
</body>

</html>